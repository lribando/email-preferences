{"version":3,"sources":["/public/js/web-account/src/email.js"],"names":["$","Dialog","Handlebars","message","pageController","request","tracking","userGuid","unsubDialog","_initToggleCities","on","e","currentTarget","value","slideDown","slideUp","_postPreferences","apiPath","getProperty","replace","getOptions","input","array","i","length","push","giltDsr","val","cityDsr","citySubs","optInOptions","opts","type","dataType","contentType","data","JSON","stringify","gilt_dsr","city_dsr","city_subscriptions","opt_in_options","processData","validate","parse","emulateHTTP","emulateJSON","addClass","post","then","removeClass","text","get","otherwise","_initSubmitPreferences","$formAreaCitiesError","preventDefault","is","animate","scrollTop","duration","_deletePreferences","delete","emailData","html","templates","section","open","_buttonClickHandler","ev","$target","target","hasClass","close","init","template","className","modal","theme","msg","buttonText","subscribe","$elementButtons","element","off","click","contact","scope","version"],"mappings":";AAAA;;;;MAEOA,C;;MACAC,M;;MACAC,U;;MACAC,O;;MACAC,c;;MACAC,O;;MACAC,Q;;;;;;;;AAGP,MAAIC,iBAAJ;AACA,MAAIC,oBAAJ;;AAEA,WAASC,iBAAT,GAA6B;AAC3BT,MAAE,wBAAF,EAA4BU,EAA5B,CAA+B,OAA/B,EAAwC,UAACC,CAAD,EAAO;AAC7C,UAAIA,EAAEC,aAAF,CAAgBC,KAAhB,KAA0B,cAA9B,EAA8C;AAC5Cb,UAAE,SAAF,EAAac,SAAb,CAAuB,MAAvB;AACD,OAFD,MAEO;AACLd,UAAE,SAAF,EAAae,OAAb,CAAqB,MAArB;AACD;AACF,KAND;AAOD;;AAED,WAASC,gBAAT,GAA4B;AAC1B,QAAIC,UAAab,eAAec,WAAf,CAA2B,sBAA3B,CAAb,yCAAJ;AACAD,cAAUA,QAAQE,OAAR,CAAgB,YAAhB,EAA8BZ,QAA9B,CAAV;;AAEA,aAASa,UAAT,CAAoBC,KAApB,EAA2B;AACzB,UAAMC,QAAQ,EAAd;AACA,WAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,MAAMG,MAA1B,EAAkCD,GAAlC,EAAuC;AACrCD,cAAMG,IAAN,CAAWJ,MAAME,CAAN,EAASV,KAApB;AACD;AACD,aAAOS,KAAP;AACD;;AAED,QAAMI,UAAU1B,EAAE,oCAAF,EAAwC2B,GAAxC,EAAhB;AACA,QAAMC,UAAU5B,EAAE,oCAAF,EAAwC2B,GAAxC,EAAhB;AACA,QAAME,WAAW7B,EAAE,iDAAF,CAAjB;AACA,QAAM8B,eAAe9B,EAAE,6CAAF,CAArB;;AAEA,QAAM+B,OAAO;AACXC,YAAM,MADK;AAEXC,gBAAU,MAFC;AAGXC,mBAAa,kBAHF;AAIXC,YAAMC,KAAKC,SAAL,CAAe;AACnBC,kBAAUZ,OADS;AAEnBa,kBAAUX,OAFS;AAGnBY,4BAAoBpB,WAAWS,QAAX,CAHD;AAInBY,wBAAgBrB,WAAWU,YAAX;AAJG,OAAf,CAJK;AAUXY,mBAAa,KAVF;AAWXC,gBAAU,IAXC;AAYXC,aAAO,IAZI;AAaXC,mBAAa,KAbF;AAcXC,mBAAa;AAdF,KAAb;;AAiBA9C,MAAE,SAAF,EAAa+C,QAAb,CAAsB,QAAtB;AACA,WAAO1C,QAAQ2C,IAAR,CAAa/B,OAAb,EACLc,KAAKI,IADA,EAELJ,IAFK,EAGLkB,IAHK,CAGA,YAAM;AACXjD,QAAE,SAAF,EAAakD,WAAb,CAAyB,QAAzB;AACAlD,QAAE,mBAAF,EAAuBmD,IAAvB,CAA4BhD,QAAQiD,GAAR,CAAY,aAAZ,EAA2B,2BAA3B,CAA5B,EAAqFF,WAArF,CAAiG,QAAjG;AACD,KANM,EAONG,SAPM,CAOI,YAAM;AACfrD,QAAE,SAAF,EAAakD,WAAb,CAAyB,QAAzB;AACAlD,QAAE,mBAAF,EAAuBmD,IAAvB,CAA4BhD,QAAQiD,GAAR,CAAY,aAAZ,EAA2B,yBAA3B,CAA5B,EAAmFL,QAAnF,CAA4F,OAA5F,EAAqGG,WAArG,CAAiH,QAAjH;AACD,KAVM,CAAP;AAWD;;AAED,WAASI,sBAAT,GAAkC;AAChC,QAAMC,uBAAuBvD,EAAE,0BAAF,CAA7B;AACAA,MAAE,mCAAF,EAAuCU,EAAvC,CAA0C,OAA1C,EAAmD,UAACC,CAAD,EAAO;AACxDA,QAAE6C,cAAF;AACA,UAAIxD,EAAE,+CAAF,EAAmDyD,EAAnD,CAAsD,UAAtD,KAAqE,CAACzD,EAAE,kCAAF,EAAsCyD,EAAtC,CAAyC,UAAzC,CAA1E,EAAgI;AAC9HF,6BAAqBL,WAArB,CAAiC,QAAjC;AACAlD,UAAE,YAAF,EAAgB0D,OAAhB,CAAwB,EAAEC,WAAW,GAAb,EAAxB,EAA4C,EAAEC,UAAU,GAAZ,EAA5C;AACD,OAHD,MAGO;AACLL,6BAAqBR,QAArB,CAA8B,QAA9B;AACA/B;AACAhB,UAAE,YAAF,EAAgB0D,OAAhB,CAAwB,EAAEC,WAAW,CAAb,EAAxB,EAA0C,EAAEC,UAAU,GAAZ,EAA1C;AACD;AACF,KAVD;AAWD;;AAED,WAASC,kBAAT,GAA8B;AAC5B,QAAI5C,UAAab,eAAec,WAAf,CAA2B,sBAA3B,CAAb,yCAAJ;AACAD,cAAUA,QAAQE,OAAR,CAAgB,YAAhB,EAA8BZ,QAA9B,CAAV;;AAEA,QAAMwB,OAAO;AACXC,YAAM,QADK;AAEXU,mBAAa,KAFF;AAGXC,gBAAU,IAHC;AAIXC,aAAO,IAJI;AAKXC,mBAAa,KALF;AAMXC,mBAAa;AANF,KAAb;;AASA9C,MAAE,SAAF,EAAa+C,QAAb,CAAsB,QAAtB;AACA,WAAO1C,QAAQyD,MAAR,CAAe7C,OAAf,EAAwBc,IAAxB,EAA8BkB,IAA9B,CAAmC,YAAM;AAC9C;AACA5C,cAAQ+C,GAAR,CAAY,qCAAZ,EAAmDH,IAAnD,CAAwD,UAACc,SAAD,EAAe;AACvE;AACE,YAAMC,OAAO9D,WAAW+D,SAAX,CAAqB,cAArB,EAAqCF,SAArC,CAAb;AACA,YAAMG,UAAUlE,EAAE,WAAF,CAAhB;AACAkE,gBAAQF,IAAR,CAAaA,IAAb;AACAhE,UAAE,SAAF,EAAakD,WAAb,CAAyB,QAAzB;AACAlD,UAAE,mBAAF,EAAuBmD,IAAvB,CAA4BhD,QAAQiD,GAAR,CAAY,aAAZ,EAA2B,iCAA3B,CAA5B,EAA2FF,WAA3F,CAAuG,QAAvG;AACAI;AACA7C;AACAT,UAAE,kBAAF,EAAsBU,EAAtB,CAAyB,OAAzB,EAAkC,YAAM;AACtCF,sBAAY2D,IAAZ;AACD,SAFD;AAGD,OAZD,EAaCd,SAbD,CAaW,YAAM;AACfrD,UAAE,SAAF,EAAakD,WAAb,CAAyB,QAAzB;AACAlD,UAAE,mBAAF,EAAuBmD,IAAvB,CAA4BhD,QAAQiD,GAAR,CAAY,aAAZ,EAA2B,yBAA3B,CAA5B,EAAmFL,QAAnF,CAA4F,OAA5F,EAAqGG,WAArG,CAAiH,QAAjH;AACD,OAhBD;AAiBD,KAnBM,CAAP;AAoBD;;AAED,MAAMkB,sBAAsB,SAAtBA,mBAAsB,CAAUC,EAAV,EAAc;AACxCA,OAAGb,cAAH;AACA,QAAMc,UAAUtE,EAAEqE,GAAGE,MAAL,CAAhB;AACA,QAAID,QAAQE,QAAR,CAAiB,SAAjB,CAAJ,EAAiC;AAC/BX;AACD;AACDrD,gBAAYiE,KAAZ;AACD,GAPD;;AASA,WAASC,IAAT,GAAgB;AACdnE,eAAWH,eAAec,WAAf,CAA2B,UAA3B,CAAX;AACAf,YAAQuE,IAAR,GAAezB,IAAf,CAAoB,YAAM;AACxBzC,oBAAc,IAAIP,MAAJ,CAAW;AACvB0E,kBAAU,oBADa;AAEvBC,mBAAW,wBAFY;AAGvBC,eAAO,IAHgB;AAIvBC,eAAO,SAJgB;AAKvB3C,cAAM;AACJ4C,eAAK5E,QAAQiD,GAAR,CAAY,aAAZ,EAA2B,eAA3B,CADD;AAEJ4B,sBAAY7E,QAAQiD,GAAR,CAAY,QAAZ,EAAsB,MAAtB;AAFR;AALiB,OAAX,CAAd;AAUA5C,kBAAYyE,SAAZ,CAAsB,QAAtB,EAAgC,YAAM;AACpC,YAAMC,kBAAkBlF,EAAEQ,YAAY2E,OAAd,CAAxB;AACAD,wBAAgBE,GAAhB,CAAoB,OAApB,EAA6BhB,mBAA7B;AACD,OAHD;;AAKA5D,kBAAYyE,SAAZ,CAAsB,QAAtB,EAAgC,YAAM;AACpC,YAAMC,kBAAkBlF,EAAEQ,YAAY2E,OAAd,CAAxB;AACAD,wBAAgBxE,EAAhB,CAAmB,OAAnB,EAA4B0D,mBAA5B;AACD,OAHD;;AAKApE,QAAE,kBAAF,EAAsBU,EAAtB,CAAyB,OAAzB,EAAkC,YAAM;AACtCF,oBAAY2D,IAAZ;AACD,OAFD;AAGD,KAxBD;AAyBAb;AACA7C;;AAGAH,aAASoE,IAAT;;AAEA1E,MAAE,YAAF,EAAgBqF,KAAhB,CAAsB,YAAM;AAC1B/E,eAASgF,OAAT,CAAiB;AACfC,eAAO,QADQ;AAEfvD,cAAM;AAFS,OAAjB;AAID,KALD;AAMD;;oBAEc;AACbwD,aAAS,qBADI;AAEbd,UAAMA;AAFO,G","file":"email.js","sourcesContent":["'use strict';\n\nimport $ from '../vendor/jquery/jquery';\nimport Dialog from '../dom/dialog/dialog';\nimport Handlebars from '../vendor/handlebars/handlebars';\nimport message from '../common/message/message';\nimport pageController from '../common/page_controller/page_controller';\nimport request from '../common/request/request';\nimport tracking from '../tracking/web_account/web_account';\n\n\nlet userGuid;\nlet unsubDialog;\n\nfunction _initToggleCities() {\n  $('input[name=\"city_dsr\"]').on('click', (e) => {\n    if (e.currentTarget.value !== 'unsubscribed') {\n      $('.cities').slideDown('slow');\n    } else {\n      $('.cities').slideUp('slow');\n    }\n  });\n}\n\nfunction _postPreferences() {\n  let apiPath = `${pageController.getProperty('publicApiAccountPath')}/user/:user_guid/email_subscriptions`;\n  apiPath = apiPath.replace(':user_guid', userGuid);\n\n  function getOptions(input) {\n    const array = [];\n    for (let i = 0; i < input.length; i++) {\n      array.push(input[i].value);\n    }\n    return array;\n  }\n\n  const giltDsr = $('input:radio[name=gilt_dsr]:checked').val();\n  const cityDsr = $('input:radio[name=city_dsr]:checked').val();\n  const citySubs = $('input:checkbox[name=city_subscriptions]:checked');\n  const optInOptions = $('input:checkbox[name=opt_in_options]:checked');\n\n  const opts = {\n    type: 'post',\n    dataType: 'json',\n    contentType: 'application/json',\n    data: JSON.stringify({\n      gilt_dsr: giltDsr,\n      city_dsr: cityDsr,\n      city_subscriptions: getOptions(citySubs),\n      opt_in_options: getOptions(optInOptions)\n    }),\n    processData: false,\n    validate: true,\n    parse: true,\n    emulateHTTP: false,\n    emulateJSON: false\n  };\n\n  $('.loader').addClass('active');\n  return request.post(apiPath,\n    opts.data,\n    opts\n  ).then(() => {\n    $('.loader').removeClass('active');\n    $('.response-message').text(message.get('web_account', 'email_preferences_success')).removeClass('hidden');\n  })\n  .otherwise(() => {\n    $('.loader').removeClass('active');\n    $('.response-message').text(message.get('web_account', 'email_preferences_error')).addClass('error').removeClass('hidden');\n  });\n}\n\nfunction _initSubmitPreferences() {\n  const $formAreaCitiesError = $('.form-area.cities .error');\n  $('.email-page .button-large-primary').on('click', (e) => {\n    e.preventDefault();\n    if ($('input[name=\"city_dsr\"][value!=\"unsubscribed\"]').is(':checked') && !$('input[name=\"city_subscriptions\"]').is(':checked')) {\n      $formAreaCitiesError.removeClass('hidden');\n      $('html, body').animate({ scrollTop: 500 }, { duration: 100 });\n    } else {\n      $formAreaCitiesError.addClass('hidden');\n      _postPreferences();\n      $('html, body').animate({ scrollTop: 0 }, { duration: 100 });\n    }\n  });\n}\n\nfunction _deletePreferences() {\n  let apiPath = `${pageController.getProperty('publicApiAccountPath')}/user/:user_guid/email_subscriptions`;\n  apiPath = apiPath.replace(':user_guid', userGuid);\n\n  const opts = {\n    type: 'delete',\n    processData: false,\n    validate: true,\n    parse: true,\n    emulateHTTP: false,\n    emulateJSON: false\n  };\n\n  $('.loader').addClass('active');\n  return request.delete(apiPath, opts).then(() => {\n    // do a get on the api again.\n    request.get('/web-account/user/email_preferences').then((emailData) => {\n    // replace container with output from handlebars\n      const html = Handlebars.templates['email/_email'](emailData);\n      const section = $('#main_col');\n      section.html(html);\n      $('.loader').removeClass('active');\n      $('.response-message').text(message.get('web_account', 'email_preferences_unsub_success')).removeClass('hidden');\n      _initSubmitPreferences();\n      _initToggleCities();\n      $('.unsubscribe-all').on('click', () => {\n        unsubDialog.open();\n      });\n    })\n    .otherwise(() => {\n      $('.loader').removeClass('active');\n      $('.response-message').text(message.get('web_account', 'email_preferences_error')).addClass('error').removeClass('hidden');\n    });\n  });\n}\n\nconst _buttonClickHandler = function (ev) {\n  ev.preventDefault();\n  const $target = $(ev.target);\n  if ($target.hasClass('confirm')) {\n    _deletePreferences();\n  }\n  unsubDialog.close();\n};\n\nfunction init() {\n  userGuid = pageController.getProperty('userGuid');\n  message.init().then(() => {\n    unsubDialog = new Dialog({\n      template: 'src/confirm_dialog',\n      className: 'generic-confirm-dialog',\n      modal: true,\n      theme: 'nouveau',\n      data: {\n        msg: message.get('web_account', 'confirm_unsub'),\n        buttonText: message.get('action', 'save')\n      }\n    });\n    unsubDialog.subscribe('closed', () => {\n      const $elementButtons = $(unsubDialog.element);\n      $elementButtons.off('click', _buttonClickHandler);\n    });\n\n    unsubDialog.subscribe('opened', () => {\n      const $elementButtons = $(unsubDialog.element);\n      $elementButtons.on('click', _buttonClickHandler);\n    });\n\n    $('.unsubscribe-all').on('click', () => {\n      unsubDialog.open();\n    });\n  });\n  _initSubmitPreferences();\n  _initToggleCities();\n\n\n  tracking.init();\n\n  $('.contact a').click(() => {\n    tracking.contact({\n      scope: 'orders',\n      type: 'cs'\n    });\n  });\n}\n\nexport default {\n  version: '$$PACKAGE_VERSION$$',\n  init: init\n};\n"]}